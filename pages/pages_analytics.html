<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网站数据分析</title>
    <link href="../css/bootstrap-v5.3.7.min.css" rel="stylesheet">
    <script src="../js/jquery-v3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>
    <style>
        .chart-container {
            width: 100%;
            height: 600px;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            background: white;
            padding: 15px;
        }
        .dashboard-header {
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="dashboard-header">
            <h1>网站数据分析</h1>
            <div class="d-flex align-items-center">
                <p class="text-muted mb-0 me-3">最后更新时间: <span id="update-time"></span></p>
                <button id="refresh-btn" class="btn btn-sm btn-outline-primary">
                    <span id="refresh-icon" class="spinner-border spinner-border-sm d-none"></span>
                    <span id="refresh-text">刷新数据</span>
                </button>
            </div>
        </div>

        <div class="row">
            <!-- ! 饼图 -->
            <div class="col-md-6">
                <div id="source-chart" class="chart-container"></div>
            </div>
            <!-- ! 柱状图 -->
            <div class="col-md-6">
                <div id="category-chart" class="chart-container"></div>
            </div>
        </div>
        <div class="row">
            <!-- ! 趋势折线图 -->
            <div class="col-md-12">
                <div id="trend-chart" class="chart-container"></div>
            </div>
        </div>
        <div class="row">
            <!-- ! 词云图 -->
            <div class="col-md-6">
                <div id="wordcloud-chart" class="chart-container"></div>
            </div>
            <!-- ! 雷达图 -->
            <div class="col-md-6">
                <div id="radar-chart" class="chart-container"></div>
            </div>
        </div>
        <div class="row">
            
        </div>
        <div class="row">
            <!-- ! 仪表盘 -->
            <div class="col-md-6">
                <div id="gauge-chart" class="chart-container"></div>
            </div>
            <!-- ! 数量漏斗图 -->
            <div class="col-md-6">
                <div id="funnel-chart" class="chart-container"></div>
            </div>
        </div>
    </div>

    <script>
            // 初始化所有图表
            $(document).ready(function() {
                // 设置更新时间
                $('#update-time').text(new Date().toLocaleString());
                
                // 初始化图表实例
                const sourceChart = echarts.init(document.getElementById('source-chart'));
                const categoryChart = echarts.init(document.getElementById('category-chart'));
                const wordcloudChart = echarts.init(document.getElementById('wordcloud-chart'));
                const trendChart = echarts.init(document.getElementById('trend-chart'));
                const radarChart = echarts.init(document.getElementById('radar-chart'));
                const gaugeChart = echarts.init(document.getElementById('gauge-chart'));
                const funnelChart = echarts.init(document.getElementById('funnel-chart'));

                // 窗口大小变化时重绘图表
                window.addEventListener('resize', function() {
                    sourceChart.resize();
                    categoryChart.resize();
                    wordcloudChart.resize();
                    trendChart.resize();
                    radarChart.resize();
                    gaugeChart.resize();
                    funnelChart.resize();
                });

            // 获取数据函数
            function fetchData(callback) {
                // 显示加载状态
                $('#refresh-icon').removeClass('d-none');
                $('#refresh-text').text('加载中...');
                $('#refresh-btn').prop('disabled', true);
                
                // 实际API请求
                $.get('../json/links_data.json', function(rawData) {
                    // 处理数据
                    const categories = rawData.map(section => section.section);
                    const linkCounts = rawData.map(section => section.links.length);
                    
                    // 计算趋势数据（模拟）
                    const trendData = linkCounts.map((count, index) => ({
                        category: categories[index],
                        count: count,
                        // 模拟趋势数据，实际项目中可以使用真实的时间序列数据
                        trend: Array.from({length: 7}, () => Math.floor(Math.random() * count * 0.5) + count * 0.75)
                    }));

                    // 计算总链接数
                    const totalLinks = linkCounts.reduce((sum, count) => sum + count, 0);
                    
                    // 找到最大和最小分类
                    const maxCategory = {
                        name: categories[linkCounts.indexOf(Math.max(...linkCounts))],
                        count: Math.max(...linkCounts)
                    };
                    
                    const minCategory = {
                        name: categories[linkCounts.indexOf(Math.min(...linkCounts))],
                        count: Math.min(...linkCounts)
                    };

                    const chartData = {
                        categories: categories,
                        linkCounts: linkCounts,
                        sections: rawData.map(section => ({
                            name: section.section,
                            value: section.links.length
                        })),
                        trendData: trendData,
                        totalLinks: totalLinks,
                        maxCategory: maxCategory,
                        minCategory: minCategory
                    };
                    
                    callback(chartData);
                    
                    // 恢复按钮状态
                    $('#refresh-icon').addClass('d-none');
                    $('#refresh-text').text('刷新数据');
                    $('#refresh-btn').prop('disabled', false);
                });
            }

            // 初始化加载数据
            fetchData(drawCharts);

            // 刷新按钮点击事件
            $('#refresh-btn').click(function() {
                fetchData(drawCharts);
            });

            // 绘制图表函数
            function drawCharts(data) {
                // 更新页面时间
                $('#update-time').text(new Date().toLocaleString());
                
                // FIXME: 柱状图
                categoryChart.setOption({
                    title: { 
                        text: '链接分类统计',
                        left: 'center',
                        top: 10
                    },
                    tooltip: { trigger: 'axis' },
                    legend: {
                        data: ['链接数量'],
                        top: 40
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        top: 80,
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: data.categories,
                        axisLabel: {
                            rotate: 45,
                            interval: 0
                        }
                    },
                    yAxis: {
                        type: 'value'
                    },
                    series: [{
                        name: '链接数量',
                        type: 'bar',
                        data: data.linkCounts,
                        itemStyle: {
                            color: function(params) {
                                // 使用不同颜色区分不同分类
                                const colorList = [
                                    '#c23531','#2f4554','#61a0a8','#d48265',
                                    '#91c7ae','#749f83','#ca8622','#bda29a',
                                    '#6e7074','#546570','#c4ccd3'
                                ];
                                return colorList[params.dataIndex % colorList.length];
                            }
                        },
                        label: {
                            show: true,
                            position: 'top'
                        }
                    }]
                });

                // FIXME: 饼图
                sourceChart.setOption({
                    title: { 
                        text: '分类占比',
                        left: 'center',
                        top: 10
                    },
                    tooltip: { trigger: 'item' },
                    series: [{
                        name: '分类占比',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: true,
                            formatter: '{b}: {c} ({d}%)'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: '18',
                                fontWeight: 'bold'
                            }
                        },
                        data: data.sections
                    }]
                });

                // FIXME: 趋势折线图
                const days = ['点1', '点2', '点3', '点4', '点5', '点6', '点7'];
                const trendSeries = data.trendData.map(item => ({
                    name: item.category,
                    type: 'line',
                    data: item.trend,
                    smooth: true
                }));

                trendChart.setOption({
                    title: { 
                        text: '各分类链接数量变化趋势（模拟）',
                        left: 'center',
                        top: 10
                    },
                    tooltip: { trigger: 'axis' },
                    legend: {
                        data: data.categories,
                        top: 40
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        top: 80,
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: days,
                        axisLabel: {
                            interval: 0,
                            rotate: 0
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: '链接数量'
                    },
                    series: trendSeries
                });

                // FIXME: 雷达图
                const indicator = data.categories.map(category => ({
                    name: category,
                    max: Math.max(...data.linkCounts) + 10
                }));

                radarChart.setOption({
                    title: { 
                        text: '各分类链接数量雷达图',
                        left: 'center',
                        top: 10
                    },
                    tooltip: {},
                    radar: {
                        indicator: indicator
                    },
                    series: [{
                        type: 'radar',
                        data: [{
                            value: data.linkCounts,
                            name: '链接数量'
                        }]
                    }]
                });

                // FIXME: 绘制仪表盘图表
                gaugeChart.setOption({
                    title: { 
                        text: '链接总数仪表盘',
                        left: 'center',
                        top: 10
                    },
                    series: [{
                        type: 'gauge',
                        startAngle: 180,
                        endAngle: 0,
                        min: 0,
                        max: data.totalLinks * 1.5,
                        splitNumber: 5,
                        axisLine: {
                            lineStyle: {
                                width: 10,
                                color: [
                                    [0.3, '#67e0e3'],
                                    [0.7, '#37a2da'],
                                    [1, '#fd666d']
                                ]
                            }
                        },
                        pointer: {
                            itemStyle: {
                                color: 'auto'
                            }
                        },
                        axisTick: {
                            distance: -10,
                            length: 8,
                            lineStyle: {
                                color: '#fff',
                                width: 2
                            }
                        },
                        splitLine: {
                            distance: -20,
                            length: 12,
                            lineStyle: {
                                color: '#fff',
                                width: 3
                            }
                        },
                        axisLabel: {
                            distance: 20,
                            color: '#999',
                            fontSize: 12
                        },
                        detail: {
                            formatter: '{value}',
                            color: 'auto',
                            fontSize: 24
                        },
                        data: [{
                            value: data.totalLinks,
                            name: '总链接数'
                        }]
                    }]
                });

                // FIXME: 漏斗图
                const funnelData = data.categories.map((category, index) => ({
                    name: category,
                    value: data.linkCounts[index]
                })).sort((a, b) => b.value - a.value);

                funnelChart.setOption({
                    title: { 
                        text: '各分类链接数量漏斗图',
                        left: 'center',
                        top: 10
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b} : {c} ({d}%)'
                    },
                    legend: {
                        data: data.categories,
                        top: 'bottom',
                        left: 'center',
                        top: 470
                    },
                    series: [{
                        name: '链接数量',
                        type: 'funnel',
                        left: '10%',
                        top: 40,
                        bottom: 100,
                        width: '80%',
                        min: 0,
                        max: funnelData[0] ? funnelData[0].value : 100,
                        minSize: '0%',
                        maxSize: '100%',
                        sort: 'descending',
                        gap: 2,
                        label: {
                            show: true,
                            position: 'inside'
                        },
                        labelLine: {
                            length: 10,
                            lineStyle: {
                                width: 1,
                                type: 'solid'
                            }
                        },
                        itemStyle: {
                            borderColor: '#fff',
                            borderWidth: 1
                        },
                        emphasis: {
                            label: {
                                fontSize: 16
                            }
                        },
                        data: funnelData
                    }]
                });

                // FIXME: 绘制词云（从链接标题中提取关键词）
                const colorPalette = [
                    '#c23531', '#2f4554', '#61a0a8', '#d48265', '#91c7ae',
                    '#749f83', '#ca8622', '#bda29a', '#6e7074', '#546570',
                    '#c4ccd3', '#dd6b66', '#759aa0', '#e69d87', '#8dc1a9',
                    '#ea7e53', '#eedd78', '#73a373', '#73b9bc', '#7289ab',
                    '#91ca8c', '#f49f42'
                ];
                
                const words = data.categories.map((category, index) => ({
                    name: category,
                    value: data.linkCounts[index] * 10,
                    textStyle: {
                        color: colorPalette[index % colorPalette.length]
                    }
                }));
                
                // 确保加载了词云扩展
                if (typeof echarts.registerMap === 'function') {
                    wordcloudChart.setOption({
                        title: { 
                            text: '分类词云',
                            left: 'center',
                            top: 10
                        },
                        tooltip: {},
                        series: [{
                            type: 'wordCloud',
                            shape: 'circle',
                            left: 'center',
                            top: 80,
                            width: '100%',
                            height: 'calc(100% - 80px)',
                            sizeRange: [12, 60],
                            rotationRange: [-45, 45],
                            rotationStep: 15,
                            gridSize: 10,
                            drawOutOfBound: true,
                            textStyle: {
                                fontFamily: 'sans-serif',
                                fontWeight: 'bold',
                                color: function () {
                                    return colorPalette[
                                        Math.floor(Math.random() * colorPalette.length)
                                    ];
                                }
                            },
                            emphasis: {
                                textStyle: {
                                    shadowBlur: 10,
                                    shadowColor: '#333'
                                }
                            },
                            data: words
                        }]
                    });
                } else {
                    console.error('WordCloud extension not loaded');
                }
            }
        });
    </script>
</body>
</html>